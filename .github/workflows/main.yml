# =============================================================
# KubeHealth Dashboard - Workflow de GitHub Actions
# =============================================================
# Este workflow automatiza la recolecciÃ³n de datos de Kubernetes y PagerDuty
# Se ejecuta cada 30 minutos y puede ser disparado manualmente

name: ğŸš€ KubeHealth Dashboard - Data Collection

on:
  # Trigger automÃ¡tico cada 30 minutos
  schedule:
    - cron: '*/30 * * * *'
  
  # Trigger manual desde la interfaz web o API
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Ejecutar en modo debug (mÃ¡s logs)'
        required: false
        default: false
        type: boolean

  # Trigger en push a main (opcional, para testing)
  push:
    branches: [ main ]
    paths: 
      - 'backend/**'
      - '.github/workflows/**'

# Variables de entorno globales
env:
  PYTHON_VERSION: '3.9'
  NODE_VERSION: '18'

jobs:
  # =============================================================
  # JOB 1: ANÃLISIS DE DATOS (Backend Python)
  # =============================================================
  data-collection:
    name: ğŸ“Š Recopilar Datos de Kubernetes y PagerDuty
    runs-on: ubuntu-latest
    
    outputs:
      status-file: ${{ steps.generate-data.outputs.status-file }}
      execution-time: ${{ steps.generate-data.outputs.execution-time }}
    
    steps:
      # Checkout del cÃ³digo
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # Setup Python
      - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # Instalar dependencias Python
      - name: ğŸ“¦ Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      # Login a Azure CLI
      - name: ğŸ” Azure CLI Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Verificar conexiÃ³n Azure
      - name: âœ… Verify Azure Connection
        run: |
          az account show
          az aks list --output table | head -10

      # Ejecutar anÃ¡lisis principal
      - name: ğŸ” Execute Data Collection
        id: generate-data
        env:
          AZURE_USER: ${{ secrets.AZURE_USER }}
          AZURE_PASSWORD: ${{ secrets.AZURE_PASSWORD }}
          PAGERDUTY_API_TOKEN: ${{ secrets.PAGERDUTY_API_TOKEN }}
          PAGERDUTY_SERVICE_ID: ${{ secrets.PAGERDUTY_SERVICE_ID }}
          DEBUG_MODE: ${{ github.event.inputs.debug_mode }}
        run: |
          echo "ğŸš€ Iniciando anÃ¡lisis de datos..."
          cd backend
          
          # Ejecutar el script principal
          if [ "${{ github.event.inputs.debug_mode }}" = "true" ]; then
            python main.py --debug
          else
            python main.py
          fi
          
          # Verificar que se generÃ³ el archivo de salida
          if [ -f "../frontend/status.json" ]; then
            echo "âœ… Archivo status.json generado correctamente"
            echo "status-file=success" >> $GITHUB_OUTPUT
            echo "execution-time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT
          else
            echo "âŒ Error: No se generÃ³ el archivo status.json"
            exit 1
          fi

      # Validar JSON generado
      - name: ğŸ” Validate Generated JSON
        run: |
          echo "ğŸ” Validando estructura del JSON..."
          python -c "
          import json
          with open('frontend/status.json', 'r') as f:
              data = json.load(f)
              print(f'âœ… JSON vÃ¡lido - Clusters: {data.get(\"summary\", {}).get(\"total_clusters\", 0)}')
              print(f'âœ… Namespaces monitoreados: {data.get(\"summary\", {}).get(\"total_namespaces_monitored\", 0)}')
              print(f'âœ… Estado general: {data.get(\"overall_status\", \"N/A\")}')
          "

      # Subir status.json como artefacto
      - name: ğŸ“¤ Upload Status Data
        uses: actions/upload-artifact@v4
        with:
          name: kubehealth-status-${{ steps.generate-data.outputs.execution-time }}
          path: frontend/status.json
          retention-days: 30

      # Mostrar resumen de ejecuciÃ³n
      - name: ğŸ“‹ Execution Summary
        run: |
          echo "## ğŸ“Š Resumen de EjecuciÃ³n" >> $GITHUB_STEP_SUMMARY
          echo "- **Fecha:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Estado:** âœ… Completado exitosamente" >> $GITHUB_STEP_SUMMARY
          echo "- **Archivo generado:** frontend/status.json" >> $GITHUB_STEP_SUMMARY

  # =============================================================
  # JOB 2: ACTUALIZAR FRONTEND (GitHub Pages)
  # =============================================================
  deploy-frontend:
    name: ğŸŒ Deploy Frontend to GitHub Pages
    runs-on: ubuntu-latest
    needs: data-collection
    if: always() && needs.data-collection.outputs.status-file == 'success'
    
    # Permisos necesarios para GitHub Pages
    permissions:
      contents: read
      pages: write
      id-token: write
    
    # Entorno para deployment
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      # Checkout del cÃ³digo
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # Setup Node.js para compilar CSS
      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # Instalar dependencias y compilar CSS
      - name: ğŸ¨ Build Frontend Assets
        run: |
          cd frontend
          npm ci
          npm run build
          echo "âœ… CSS compilado correctamente"

      # Descargar el archivo status.json del job anterior
      - name: ğŸ“¥ Download Status Data
        uses: actions/download-artifact@v4
        with:
          name: kubehealth-status-${{ needs.data-collection.outputs.execution-time }}
          path: frontend/

      # Configurar GitHub Pages
      - name: ğŸ”§ Setup GitHub Pages
        uses: actions/configure-pages@v4

      # Subir artefactos para Pages
      - name: ğŸ“¤ Upload GitHub Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: frontend/

      # Deploy a GitHub Pages
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # Resumen del deployment
      - name: ğŸŒ Deployment Summary
        run: |
          echo "## ğŸŒ Frontend Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Estado:** âœ… Deployed successfully" >> $GITHUB_STEP_SUMMARY
          echo "- **Datos actualizados:** ${{ needs.data-collection.outputs.execution-time }}" >> $GITHUB_STEP_SUMMARY

  # =============================================================
  # JOB 3: NOTIFICACIONES (Opcional)
  # =============================================================
  notifications:
    name: ğŸ“¢ Send Notifications
    runs-on: ubuntu-latest
    needs: [data-collection, deploy-frontend]
    if: always() && (failure() || success())
    
    steps:
      - name: ğŸ“§ Notify on Success
        if: needs.data-collection.result == 'success' && needs.deploy-frontend.result == 'success'
        run: |
          echo "âœ… KubeHealth Dashboard actualizado exitosamente"
          echo "ğŸ“Š Datos recopilados: ${{ needs.data-collection.outputs.execution-time }}"
          # AquÃ­ se pueden agregar notificaciones a Slack, Teams, etc.

      - name: ğŸš¨ Notify on Failure
        if: failure()
        run: |
          echo "âŒ Error en KubeHealth Dashboard workflow"
          echo "ğŸ” Revisar logs para mÃ¡s detalles"
          # AquÃ­ se pueden agregar notificaciones de error